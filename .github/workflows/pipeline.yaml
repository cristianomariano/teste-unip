name: Deploy website

on:
  workflow_dispatch:
  push:
    branches: [ main ]

#env:
#  ARM_CLIENT_ID: "${{ secrets.AZURE_CLIENT_ID }}"
#  ARM_SUBSCRIPTION_ID: "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
#  ARM_TENANT_ID: "${{ secrets.AZURE_TENANT_ID }}"

jobs:

  build:
    name: Build and deploy
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
      
#    - name: Install Node.js
#      uses: actions/setup-node@v1
#      with:
#        node-version: 12.x
      
#    - name: Build website
#      run: |
#        npm install
#        npm run build
        
#    - name: Deploy to Azure
#      uses: TravisSpomer/deploy-to-azure-storage@v1.4.0
#      with:
#        source-path: public
#        sas-url: ${{ secrets.DEPLOY_SAS_URL }}
#        container: aluno01

  infra:
    name: Terraform Infra
    runs-on: ubuntu-latest
    environment: dev
    needs: build
    defaults:
      run:
        working-directory: ./infra

    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v3

    # Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.
    - name: Az Login
      run: az login --use-device-code

    # Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.
    - name: Az Set Subscription
      run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # Install the latest version of Terraform CLI and configure the Terraform CLI configuration file with a Terraform Cloud user API token
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    # Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.
    - name: Terraform Init
      run: terraform init

    - name: Terraform Import
      run: terraform import azurerm_resource_group.rg /subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.AZURE_RESOURCE_GROUP_ID }} -var='resource_group_name=${{ secrets.AZURE_RESOURCE_GROUP_ID }}'

    # Terraform Apply
    - name: Terraform Apply
      run: terraform apply -auto-approve